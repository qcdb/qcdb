<!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->






<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>qcdb.molecule.molecule</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/psi4.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>

    
    
     
        <script src="../../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../../_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="../../../_static/favicon-qcdb.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../../../index.html" title="Table Of Contents"
             accesskey="C"><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="https://github.com/qcdb/qcdb/blob/master/README.md"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="https://github.com/qcdb/qcdb"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="https://github.com/qcdb/qcdb/edit/master/docs/sphinx/_modules/qcdb/molecule/molecule.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="https://github.com/qcdb/qcdb/tree/0+untagged.1.ga43ff39">0+untagged.1.ga43ff39</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="../../../index.html">
        <span style="font-family: Optima, sans-serif;">QCDB</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>
        <li class="nav-item nav-item-this"><a href="">qcdb.molecule.molecule</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for qcdb.molecule.molecule</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">qcelemental</span> <span class="k">as</span> <span class="nn">qcel</span>

<span class="kn">from</span> <span class="nn">..bfs</span> <span class="kn">import</span> <span class="n">BFS</span>
<span class="kn">from</span> <span class="nn">..testing</span> <span class="kn">import</span> <span class="n">compare</span><span class="p">,</span> <span class="n">compare_molrecs</span><span class="p">,</span> <span class="n">compare_values</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">parse_dertype</span>
<span class="kn">from</span> <span class="nn">..util.vecutil</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.libmintsmolecule</span> <span class="kn">import</span> <span class="n">FULL_PG_TOL</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">LibmintsMolecule</span>


<div class="viewcode-block" id="Molecule"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule">[docs]</a><span class="k">class</span> <span class="nc">Molecule</span><span class="p">(</span><span class="n">LibmintsMolecule</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to store the elements, coordinates, fragmentation pattern,</span>
<span class="sd">    charge, multiplicity of a molecule. Largely replicates psi4&#39;s libmints</span>
<span class="sd">    Molecule class, developed by Justin M. Turney and Andy M. Simmonett</span>
<span class="sd">    with incremental improvements by other psi4 developers. Major</span>

<span class="sd">    This class extends LibmintsMolecule and occasionally</span>
<span class="sd">    :py:class:`psi4.core.Molecule` itself.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">molinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">geom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">elea</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">elez</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">elem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">real</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">elbl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span>
                 <span class="n">input_units_to_au</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fix_com</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fix_orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fix_symmetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fragment_separators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fragment_charges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fragment_multiplicities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">molecular_charge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">molecular_multiplicity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">provenance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">connectivity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">enable_qm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">enable_efp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">missing_enabled_return_qm</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                 <span class="n">missing_enabled_return_efp</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                 <span class="n">missing_enabled_return</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                 <span class="n">tooclose</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">zero_ghost_fragments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">nonphysical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">mtol</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Molecule object from LibmintsMolecule&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Molecule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">molinit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">molinit</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">molrec</span> <span class="o">=</span> <span class="n">molinit</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">molinit</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">compound_molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span>
                    <span class="n">molstr</span><span class="o">=</span><span class="n">molinit</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">fix_com</span><span class="o">=</span><span class="n">fix_com</span><span class="p">,</span>
                    <span class="n">fix_orientation</span><span class="o">=</span><span class="n">fix_orientation</span><span class="p">,</span>
                    <span class="n">fix_symmetry</span><span class="o">=</span><span class="n">fix_symmetry</span><span class="p">,</span>
                    <span class="n">return_processed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">enable_qm</span><span class="o">=</span><span class="n">enable_qm</span><span class="p">,</span>
                    <span class="n">enable_efp</span><span class="o">=</span><span class="n">enable_efp</span><span class="p">,</span>
                    <span class="n">missing_enabled_return_qm</span><span class="o">=</span><span class="n">missing_enabled_return_qm</span><span class="p">,</span>
                    <span class="n">missing_enabled_return_efp</span><span class="o">=</span><span class="n">missing_enabled_return_efp</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">molrec</span> <span class="o">=</span> <span class="n">compound_molrec</span><span class="p">[</span><span class="s1">&#39;qm&#39;</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">molinit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span>
                    <span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span>
                    <span class="n">elea</span><span class="o">=</span><span class="n">elea</span><span class="p">,</span>
                    <span class="n">elez</span><span class="o">=</span><span class="n">elez</span><span class="p">,</span>
                    <span class="n">elem</span><span class="o">=</span><span class="n">elem</span><span class="p">,</span>
                    <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span>
                    <span class="n">real</span><span class="o">=</span><span class="n">real</span><span class="p">,</span>
                    <span class="n">elbl</span><span class="o">=</span><span class="n">elbl</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
                    <span class="n">input_units_to_au</span><span class="o">=</span><span class="n">input_units_to_au</span><span class="p">,</span>
                    <span class="n">fix_com</span><span class="o">=</span><span class="n">fix_com</span><span class="p">,</span>
                    <span class="n">fix_orientation</span><span class="o">=</span><span class="n">fix_orientation</span><span class="p">,</span>
                    <span class="n">fix_symmetry</span><span class="o">=</span><span class="n">fix_symmetry</span><span class="p">,</span>
                    <span class="n">fragment_separators</span><span class="o">=</span><span class="n">fragment_separators</span><span class="p">,</span>
                    <span class="n">fragment_charges</span><span class="o">=</span><span class="n">fragment_charges</span><span class="p">,</span>
                    <span class="n">fragment_multiplicities</span><span class="o">=</span><span class="n">fragment_multiplicities</span><span class="p">,</span>
                    <span class="n">molecular_charge</span><span class="o">=</span><span class="n">molecular_charge</span><span class="p">,</span>
                    <span class="n">molecular_multiplicity</span><span class="o">=</span><span class="n">molecular_multiplicity</span><span class="p">,</span>
                    <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
                    <span class="n">provenance</span><span class="o">=</span><span class="n">provenance</span><span class="p">,</span>
                    <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">,</span>
                    <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;qm&#39;</span><span class="p">,</span>
                    <span class="n">missing_enabled_return</span><span class="o">=</span><span class="n">missing_enabled_return</span><span class="p">,</span>
                    <span class="n">tooclose</span><span class="o">=</span><span class="n">tooclose</span><span class="p">,</span>
                    <span class="n">zero_ghost_fragments</span><span class="o">=</span><span class="n">zero_ghost_fragments</span><span class="p">,</span>
                    <span class="n">nonphysical</span><span class="o">=</span><span class="n">nonphysical</span><span class="p">,</span>
                    <span class="n">mtol</span><span class="o">=</span><span class="n">mtol</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="c1"># ok, got the molrec dictionary; now build the thing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_internal_from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># The comment line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tagline</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;  ==&gt; qcdb Molecule </span><span class="si">%s</span><span class="s2"> &lt;==</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;   =&gt; </span><span class="si">%s</span><span class="s2"> &lt;=</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagline</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_psi4_string_from_molecule</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to overload setting attributes to allow geometry</span>
<span class="sd">        variable assigment as if member data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;all_variables&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;all_variables&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Molecule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to overload accessing attribute contents to allow</span>
<span class="sd">        retrival of geometry variable values as if member data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;all_variables&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;all_variables&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Molecule.init_with_xyz"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.init_with_xyz">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">init_with_xyz</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xyzfilename</span><span class="p">,</span> <span class="n">no_com</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_reorient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">contentsNotFilename</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull information from an XYZ file. No fragment info detected.</span>
<span class="sd">        Bohr/Angstrom pulled from first line if available.  Charge,</span>
<span class="sd">        multiplicity, tagline pulled from second line if available.  Body</span>
<span class="sd">        accepts atom symbol or atom charge in first column. Arguments</span>
<span class="sd">        *no_com* and *no_reorient* can be used to turn off shift and</span>
<span class="sd">        rotation. If *xyzfilename* is a string of the contents of an XYZ</span>
<span class="sd">        file, rather than the name of a file, set *contentsNotFilename*</span>
<span class="sd">        to ``True``.</span>

<span class="sd">        &gt;&gt;&gt; H2O = qcdb.Molecule.init_with_xyz(&#39;h2o.xyz&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">FeatureDeprecated</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;qcdb.Molecule.init_with_xyz. Replace with: qcdb.Molecule.from_string(..., dtype=&#39;xyz+&#39;)&quot;&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.init_with_mol2"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.init_with_mol2">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">init_with_mol2</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xyzfilename</span><span class="p">,</span> <span class="n">no_com</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_reorient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">contentsNotFilename</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull information from a MOl2 file. No fragment info detected.</span>
<span class="sd">        Bohr/Angstrom pulled from first line if available.  Charge,</span>
<span class="sd">        multiplicity, tagline pulled from second line if available.  Body</span>
<span class="sd">        accepts atom symbol or atom charge in first column. Arguments</span>
<span class="sd">        *no_com* and *no_reorient* can be used to turn off shift and</span>
<span class="sd">        rotation. If *xyzfilename* is a string of the contents of an XYZ</span>
<span class="sd">        file, rather than the name of a file, set *contentsNotFilename*</span>
<span class="sd">        to ``True``.</span>

<span class="sd">        NOTE: chg/mult NYI</span>

<span class="sd">        &gt;&gt;&gt; H2O = qcdb.Molecule.init_with_mol2(&#39;h2o.mol2&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">lock_frame</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">PYmove_to_com</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">no_com</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">PYfix_orientation</span> <span class="o">=</span> <span class="n">no_reorient</span>

        <span class="k">if</span> <span class="n">contentsNotFilename</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">xyzfilename</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">xyzfilename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Molecule::init_with_mol2: given filename &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist.&quot;&quot;&quot;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">xyzfilename</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">xyzfilename</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Molecule::init_with_mol2: given filename &#39;</span><span class="si">%s</span><span class="s2">&#39; is blank.&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xyzfilename</span><span class="p">))</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="c1"># fixed-width regex ((?=[ ]*-?\d+)[ -\d]{5})</span>
        <span class="n">v2000</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^((?=[ ]*\d+)[ \d]</span><span class="si">{3}</span><span class="s1">)((?=[ ]*\d+)[ \d]</span><span class="si">{3}</span><span class="s1">)(.*)V2000\s*$&#39;</span><span class="p">)</span>
        <span class="n">vend</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*M\s+END\s*$&#39;</span><span class="p">)</span>
        <span class="n">NUMBER</span> <span class="o">=</span> <span class="s2">&quot;((?:[-+]?</span><span class="se">\\</span><span class="s2">d*</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d+(?:[DdEe][-+]?</span><span class="se">\\</span><span class="s2">d+)?)|(?:[-+]?</span><span class="se">\\</span><span class="s2">d+</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d*(?:[DdEe][-+]?</span><span class="se">\\</span><span class="s2">d+)?))&quot;</span>
        <span class="n">xyzM</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;^(?:\s*)&#39;</span> <span class="o">+</span> <span class="n">NUMBER</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;(?:\s+)&#39;</span> <span class="o">+</span> <span class="n">NUMBER</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;(?:\s+)&#39;</span> <span class="o">+</span> <span class="n">NUMBER</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;(?:\s+)([A-Z](?:[a-z])?)(?:\s+)(.*)&#39;</span><span class="p">,</span>
            <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

        <span class="c1">## now charge and multiplicity</span>
        <span class="c1">#   $chargem = 0  ; $multm = 1 ;</span>
        <span class="c1">#while (&lt;MOL&gt;) {</span>
        <span class="c1">#if (/CHARGE/) { $chargem = &lt;MOL&gt; ; chop($chargem) ;}</span>
        <span class="c1">#if (/MULTIPLICITY/) { $multm = &lt;MOL&gt; ; chop($multm) }</span>
        <span class="c1">#        } # end while charge and multiplicity</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Molecule::init_with_mol2: file blank&quot;</span><span class="p">)</span>
        <span class="c1"># Try to match header/footer</span>
        <span class="k">if</span> <span class="n">vend</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Molecule::init_with_mol2: Malformed file termination</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">sysname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">tagline</span> <span class="o">=</span> <span class="n">sysname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">comment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">tagline</span> <span class="o">=</span> <span class="n">sysname</span>
        <span class="c1">#instance.tagline = text[0].strip() + &#39; &#39; + text[2].strip()</span>
        <span class="n">fileUnits</span> <span class="o">=</span> <span class="s1">&#39;Angstrom&#39;</span>  <span class="c1"># defined for MOL</span>
        <span class="c1">#instance.set_molecular_charge(int(xyz2.match(text[1]).group(1)))</span>
        <span class="c1">#instance.set_multiplicity(int(xyz2.match(text[1]).group(2)))</span>
        <span class="k">if</span> <span class="n">v2000</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">fileNatom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v2000</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Molecule::init_with_mol2: Malformed fourth line</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">fileNatom</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Molecule::init_with_mol2: Malformed Natom</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fileNatom</span><span class="p">)))</span>

        <span class="c1"># Next line begins the useful information.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fileNatom</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">xyzM</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">]):</span>

                    <span class="n">fileX</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyzM</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">fileY</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyzM</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">fileZ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xyzM</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                    <span class="n">fileAtom</span> <span class="o">=</span> <span class="n">xyzM</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

                    <span class="c1"># Check that the atom symbol is valid</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">periodictable</span><span class="o">.</span><span class="n">to_Z</span><span class="p">(</span><span class="n">fileAtom</span><span class="p">)</span>

                    <span class="c1"># Add it to the molecule.</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">fileX</span><span class="p">,</span> <span class="n">fileY</span><span class="p">,</span> <span class="n">fileZ</span><span class="p">,</span> <span class="n">fileAtom</span><span class="p">,</span> <span class="n">qcel</span><span class="o">.</span><span class="n">periodictable</span><span class="o">.</span><span class="n">to_mass</span><span class="p">(</span><span class="n">fileAtom</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Molecule::init_with_mol2: Malformed atom information line </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">))</span>

            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Molecule::init_with_mol2: Expected atom in file at line </span><span class="si">%d</span><span class="s2">.</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]))</span>

        <span class="c1"># We need to make 1 fragment with all atoms</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">fragments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">fileNatom</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">fragment_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Real&#39;</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">fragment_charges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">molecular_charge</span><span class="p">())</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">fragment_multiplicities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">())</span>
        <span class="c1"># Set the units properly</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">PYunits</span> <span class="o">=</span> <span class="n">fileUnits</span>
        <span class="k">if</span> <span class="n">fileUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">PYinput_units_to_au</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">fileUnits</span> <span class="o">==</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">PYinput_units_to_au</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instance</span></div>

<div class="viewcode-block" id="Molecule.save_string_xyz"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.save_string_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">save_string_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_ghosts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_natom</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save a string for a XYZ-style file.</span>

<span class="sd">        &gt;&gt;&gt; H2OH2O.save_string_xyz()</span>
<span class="sd">        6</span>
<span class="sd">        -2 3 water_dimer</span>
<span class="sd">         O   -1.551007000000   -0.114520000000    0.000000000000</span>
<span class="sd">         H   -1.934259000000    0.762503000000    0.000000000000</span>
<span class="sd">         H   -0.599677000000    0.040712000000    0.000000000000</span>
<span class="sd">         O    1.350625000000    0.111469000000    0.000000000000</span>
<span class="sd">         H    1.680398000000   -0.373741000000   -0.758561000000</span>
<span class="sd">         H    1.680398000000   -0.373741000000    0.758561000000</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PYunits</span> <span class="o">==</span> <span class="s1">&#39;Angstrom&#39;</span> <span class="k">else</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span>

        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">save_ghosts</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">save_natom</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_charge</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagline</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">()):</span>
            <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">save_ghosts</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%2s</span><span class="s1"> </span><span class="si">%17.12f</span><span class="s1"> </span><span class="si">%17.12f</span><span class="s1"> </span><span class="si">%17.12f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Gh&quot;</span><span class="p">),</span> \
                    <span class="n">x</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">z</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span></div>

<div class="viewcode-block" id="Molecule.save_xyz"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.save_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">save_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">save_ghosts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_natom</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save an XYZ file.</span>

<span class="sd">        &gt;&gt;&gt; H2OH2O.save_xyz(&#39;h2o.xyz&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_string_xyz</span><span class="p">(</span><span class="n">save_ghosts</span><span class="p">,</span> <span class="n">save_natom</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Molecule.format_molecule_for_psi4"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.format_molecule_for_psi4">[docs]</a>    <span class="k">def</span> <span class="nf">format_molecule_for_psi4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns string of molecule definition block.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;molecule mol {</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_psi4_string_from_molecule</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;   &#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">text</span></div>

<div class="viewcode-block" id="Molecule.format_basis_for_cfour"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.format_basis_for_cfour">[docs]</a>    <span class="k">def</span> <span class="nf">format_basis_for_cfour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">puream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to print the BASIS=SPECIAL block for Cfour according</span>
<span class="sd">        to the active atoms in Molecule. Special short basis names</span>
<span class="sd">        are used by Psi4 libmints GENBAS-writer in accordance with</span>
<span class="sd">        Cfour constraints.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_types</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Absent&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">fr</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">fr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">%s</span><span class="s2">:P4_</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">cr</span><span class="p">)</span>
                    <span class="n">cr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">][</span><span class="s1">&#39;CFOUR_BASIS&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SPECIAL&#39;</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">][</span><span class="s1">&#39;CFOUR_SPHERICAL&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">puream</span>

        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">][</span><span class="s1">&#39;CFOUR_BASIS&#39;</span><span class="p">][</span><span class="s1">&#39;clobber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">][</span><span class="s1">&#39;CFOUR_SPHERICAL&#39;</span><span class="p">][</span><span class="s1">&#39;clobber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">][</span><span class="s1">&#39;CFOUR_BASIS&#39;</span><span class="p">][</span><span class="s1">&#39;superclobber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">][</span><span class="s1">&#39;CFOUR_SPHERICAL&#39;</span><span class="p">][</span><span class="s1">&#39;superclobber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>

    <span class="c1">#def format_molecule_for_qchem(self, mixedbas=True):</span>
    <span class="c1">#    &quot;&quot;&quot;Returns geometry section of input file formatted for Q-Chem.</span>
    <span class="c1">#    For ghost atoms, prints **Gh** as elemental symbol, with expectation</span>
    <span class="c1">#    that element identity will be established in mixed basis section.</span>
    <span class="c1">#    For ghost atoms when *mixedbas* is False, prints @ plus element symbol.</span>

<div class="viewcode-block" id="Molecule.format_basis_for_nwchem"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.format_basis_for_nwchem">[docs]</a>    <span class="k">def</span> <span class="nf">format_basis_for_nwchem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basopt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to print NWChem-style basis sets into [basis block] according</span>
<span class="sd">        to the active atoms in Molecule. Basis sets are loaded from Psi4 basis sets library. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_types</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Absent&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">basopt</span><span class="o">.</span><span class="n">print_detail_nwchem</span><span class="p">()</span>

        <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;end </span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>

<div class="viewcode-block" id="Molecule.format_basis_for_nwchem_puream"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.format_basis_for_nwchem_puream">[docs]</a>    <span class="k">def</span> <span class="nf">format_basis_for_nwchem_puream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">puream</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to recognize puream for NWChem </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">puream</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;basis spherical </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;basis </span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1">#Default : cartesian</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">options</span></div>

<div class="viewcode-block" id="Molecule.inertia_tensor"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.inertia_tensor">[docs]</a>    <span class="k">def</span> <span class="nf">inertia_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masswt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zero</span><span class="o">=</span><span class="n">ZERO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute inertia tensor.</span>

<span class="sd">        &gt;&gt;&gt; print H2OH2O.inertia_tensor()</span>
<span class="sd">        [[8.704574864178731, -8.828375721817082, 0.0], [-8.828375721817082, 280.82861714077666, 0.0], [0.0, 0.0, 281.249500988553]]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertia_tensor_partial</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">()),</span> <span class="n">masswt</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.inertia_tensor_partial"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.inertia_tensor_partial">[docs]</a>    <span class="k">def</span> <span class="nf">inertia_tensor_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">masswt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zero</span><span class="o">=</span><span class="n">ZERO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute inertia tensor based on atoms in *part*.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">masswt</span><span class="p">:</span>
                <span class="c1"># I(alpha, alpha)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

                <span class="c1"># I(alpha, beta)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># I(alpha, alpha)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="c1"># I(alpha, beta)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># mirror</span>
        <span class="n">tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Check the elements for zero and make them a hard zero.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">tensor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">zero</span><span class="p">:</span>
                    <span class="n">tensor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">tensor</span></div>

<div class="viewcode-block" id="Molecule.inertial_system_partial"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.inertial_system_partial">[docs]</a>    <span class="k">def</span> <span class="nf">inertial_system_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">masswt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zero</span><span class="o">=</span><span class="n">ZERO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve inertial system based on atoms in *part*&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">diagonalize3x3symmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inertia_tensor_partial</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">masswt</span><span class="p">,</span> <span class="n">zero</span><span class="p">))</span></div>

<div class="viewcode-block" id="Molecule.inertial_system"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.inertial_system">[docs]</a>    <span class="k">def</span> <span class="nf">inertial_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masswt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zero</span><span class="o">=</span><span class="n">ZERO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve inertial system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">diagonalize3x3symmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inertia_tensor</span><span class="p">(</span><span class="n">masswt</span><span class="p">,</span> <span class="n">zero</span><span class="p">))</span></div>

<div class="viewcode-block" id="Molecule.print_ring_planes"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.print_ring_planes">[docs]</a>    <span class="k">def</span> <span class="nf">print_ring_planes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity1</span><span class="p">,</span> <span class="n">entity2</span><span class="p">,</span> <span class="n">entity3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">entity4</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(reals only, 1-indexed)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO allow handle lines</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">summ</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#for entity in [entity1, entity2, entity3, entity4]:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">entity1</span><span class="p">,</span> <span class="n">entity2</span><span class="p">]:</span>

            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">  ==&gt; Entity </span><span class="si">%s</span><span class="s2"> &lt;==</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="c1"># convert plain atoms into list and move from 1-indexed to 0-indexed</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">entity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;point&#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;line&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;plane&#39;</span>

            <span class="c1"># compute centroid</span>
            <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">:</span>
                <span class="n">cent</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">cent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
            <span class="n">cent</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">cent</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Centroid:      </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1">                  [Angstrom]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span><span class="p">,</span> \
                 <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span><span class="p">,</span> \
                 <span class="n">cent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Centroid:      </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1">                  [Bohr]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cent</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
                <span class="n">summ</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span> <span class="s1">&#39;cent&#39;</span><span class="p">:</span> <span class="n">cent</span><span class="p">})</span>
                <span class="c1"># TODO: figure out if should be using mass-weighted</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">cent</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertial_system_partial</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">masswt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">midx</span> <span class="o">=</span> <span class="n">evals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">evals</span><span class="p">))</span>

            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Normal Vector: </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1">                  [unit]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">midx</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">midx</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">midx</span><span class="p">])</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Normal Vector: </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1">                  [unit]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">+</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">+</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">+</span> <span class="n">cent</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">xplane</span> <span class="o">=</span> <span class="p">[</span><span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">midx</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">midx</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">midx</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">*</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">*</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">*</span> <span class="n">cent</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Eqn. of Plane: </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1">   [Ai + Bj + Ck + D = 0]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">xplane</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xplane</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xplane</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xplane</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">dtemp</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">*</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">+</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">*</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">+</span>
                              <span class="n">evecs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">*</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">midx</span><span class="p">])</span>
            <span class="n">hessplane</span> <span class="o">=</span> <span class="p">[</span><span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">/</span> <span class="n">dtemp</span><span class="p">,</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">/</span> <span class="n">dtemp</span><span class="p">,</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">midx</span><span class="p">]</span> <span class="o">/</span> <span class="n">dtemp</span><span class="p">,</span> <span class="n">xplane</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">dtemp</span><span class="p">]</span>
            <span class="n">hessplane2</span> <span class="o">=</span> <span class="p">[</span><span class="n">xplane</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">dtemp</span><span class="p">,</span> <span class="n">xplane</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dtemp</span><span class="p">,</span> <span class="n">xplane</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">dtemp</span><span class="p">,</span> <span class="n">xplane</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">dtemp</span><span class="p">]</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Eqn. of Plane: </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1">   [Ai + Bj + Ck + D = 0] H</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">hessplane</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hessplane</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hessplane</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hessplane</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Eqn. of Plane: </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1">   [Ai + Bj + Ck + D = 0] H2</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">hessplane2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hessplane2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hessplane2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hessplane2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s1">&#39;plane&#39;</span><span class="p">:</span>
                <span class="n">summ</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="n">xplane</span><span class="p">,</span> <span class="s1">&#39;cent&#39;</span><span class="p">:</span> <span class="n">cent</span><span class="p">})</span>

        <span class="c1">#print summ</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">  ==&gt; 1 (</span><span class="si">%s</span><span class="s2">) vs. 2 (</span><span class="si">%s</span><span class="s2">) &lt;==</span><span class="se">\n\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dim&#39;</span><span class="p">],</span> <span class="n">summ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dim&#39;</span><span class="p">])</span>

        <span class="c1">#if summ[0][&#39;dim&#39;] == &#39;plane&#39; and summ[1][&#39;dim&#39;] == &#39;point&#39;:</span>
        <span class="c1">#    cent = summ[1][&#39;geo&#39;]</span>
        <span class="c1">#    plane = summ[0][&#39;geo&#39;]</span>
        <span class="c1">#    print cent, plane</span>
        <span class="c1">#</span>
        <span class="c1">#    D = math.fabs(plane[0] * cent[0] + plane[1] * cent[1] + plane[2] * cent[2] + plane[3]) / \</span>
        <span class="c1">#        math.sqrt(plane[0] * plane[0] + plane[1] * plane[1] + plane[2] * plane[2])</span>
        <span class="c1">#    text += &#39;  Pt to Plane: %14.8f [Angstrom]\n&#39; % (D * psi_bohr2angstroms)</span>

        <span class="c1">#if summ[0][&#39;dim&#39;] == &#39;plane&#39; and summ[1][&#39;dim&#39;] == &#39;plane&#39;:</span>
        <span class="k">if</span> <span class="n">summ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;plane&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">summ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;plane&#39;</span> <span class="ow">or</span> <span class="n">summ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">):</span>
            <span class="n">cent1</span> <span class="o">=</span> <span class="n">summ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cent&#39;</span><span class="p">]</span>
            <span class="n">cent2</span> <span class="o">=</span> <span class="n">summ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;cent&#39;</span><span class="p">]</span>
            <span class="n">plane1</span> <span class="o">=</span> <span class="n">summ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span>
            <span class="c1">#plane2 = summ[1][&#39;geo&#39;]</span>

            <span class="n">distCC</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">cent1</span><span class="p">,</span> <span class="n">cent2</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Distance from Center of </span><span class="si">%s</span><span class="s1"> to Center of </span><span class="si">%s</span><span class="s1">:                   </span><span class="si">%14.8f</span><span class="s1">   [Angstrom]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">distCC</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span><span class="p">)</span>

            <span class="n">distCP</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">plane1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cent2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">plane1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cent2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">plane1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">cent2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">plane1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="c1"># distCP expression has a denominator that&#39;s one since plane constructed from unit vector</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Distance from Center of </span><span class="si">%s</span><span class="s1"> to Plane of </span><span class="si">%s</span><span class="s1">:                    </span><span class="si">%14.8f</span><span class="s1">   [Angstrom]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">distCP</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span><span class="p">)</span>

            <span class="n">distCPC</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">distCC</span> <span class="o">*</span> <span class="n">distCC</span> <span class="o">-</span> <span class="n">distCP</span> <span class="o">*</span> <span class="n">distCP</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;  Distance from Center of </span><span class="si">%s</span><span class="s1"> to Center of </span><span class="si">%s</span><span class="s1"> along Plane of </span><span class="si">%s</span><span class="s1">:  </span><span class="si">%14.8f</span><span class="s1">   [Angstrom]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">distCPC</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

<span class="c1">#        text = &quot;        Interatomic Distances (Angstroms)\n\n&quot;</span>
<span class="c1">#        for i in range(self.natom()):</span>
<span class="c1">#            for j in range(i + 1, self.natom()):</span>
<span class="c1">#                eij = sub(self.xyz(j), self.xyz(i))</span>
<span class="c1">#                dist = norm(eij) * psi_bohr2angstroms</span>
<span class="c1">#                text += &quot;        Distance %d to %d %-8.3lf\n&quot; % (i + 1, j + 1, dist)</span>
<span class="c1">#        text += &quot;\n\n&quot;</span>
<span class="c1">#        return text</span>

<div class="viewcode-block" id="Molecule.rotor_type"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.rotor_type">[docs]</a>    <span class="k">def</span> <span class="nf">rotor_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">FULL_PG_TOL</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the rotor type.</span>

<span class="sd">        &gt;&gt;&gt; H2OH2O.rotor_type()</span>
<span class="sd">        RT_ASYMMETRIC_TOP</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">diagonalize3x3symmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inertia_tensor</span><span class="p">())</span>
        <span class="n">evals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span>

        <span class="n">rot_const</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mf">1.0</span> <span class="o">/</span> <span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0e-6</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">evals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">evals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0e-6</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="mf">1.0</span> <span class="o">/</span> <span class="n">evals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">evals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0e-6</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">]</span>

        <span class="c1"># Determine degeneracy of rotational constants.</span>
        <span class="n">degen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">degen</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">rabs</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">rot_const</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">rot_const</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">rot_const</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">rot_const</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rot_const</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">else</span> <span class="n">rot_const</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">rabs</span> <span class="o">&gt;</span> <span class="n">ZERO</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="n">rabs</span> <span class="o">/</span> <span class="n">tmp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rel</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">rel</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="n">degen</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1">#print &quot;\tDegeneracy is %d\n&quot; % (degen)</span>

        <span class="c1"># Determine rotor type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rotor_type</span> <span class="o">=</span> <span class="s1">&#39;RT_ATOM&#39;</span>
        <span class="k">elif</span> <span class="n">rot_const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">rotor_type</span> <span class="o">=</span> <span class="s1">&#39;RT_LINEAR&#39;</span>  <span class="c1"># 0  &lt;  IB == IC      inf &gt; B == C</span>
        <span class="k">elif</span> <span class="n">degen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rotor_type</span> <span class="o">=</span> <span class="s1">&#39;RT_SPHERICAL_TOP&#39;</span>  <span class="c1"># IA == IB == IC       A == B == C</span>
        <span class="k">elif</span> <span class="n">degen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rot_const</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rot_const</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.0e-6</span><span class="p">:</span>
                <span class="n">rotor_type</span> <span class="o">=</span> <span class="s1">&#39;RT_PROLATE_SYMMETRIC_TOP&#39;</span>  <span class="c1"># IA &lt;  IB == IC       A &gt;  B == C</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">rot_const</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rot_const</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.0e-6</span><span class="p">:</span>
                <span class="n">rotor_type</span> <span class="o">=</span> <span class="s1">&#39;RT_OBLATE_SYMMETRIC_TOP&#39;</span>  <span class="c1"># IA == IB &lt;  IC       A == B &gt;  C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rotor_type</span> <span class="o">=</span> <span class="s1">&#39;RT_ASYMMETRIC_TOP&#39;</span>  <span class="c1"># IA &lt;  IB &lt;  IC       A  &gt; B &gt;  C</span>
        <span class="k">return</span> <span class="n">rotor_type</span></div>

<div class="viewcode-block" id="Molecule.center_of_charge"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.center_of_charge">[docs]</a>    <span class="k">def</span> <span class="nf">center_of_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes center of charge of molecule (does not translate molecule).</span>

<span class="sd">        &gt;&gt;&gt; H2OH2O.center_of_charge()</span>
<span class="sd">        [-0.073339893272065401, 0.002959783555632145, 0.0]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="n">total_c</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">()):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">(</span><span class="n">at</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>
            <span class="n">total_c</span> <span class="o">+=</span> <span class="n">c</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">total_c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Molecule.move_to_coc"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.move_to_coc">[docs]</a>    <span class="k">def</span> <span class="nf">move_to_coc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Moves molecule to center of charge</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coc</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_of_charge</span><span class="p">(),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">coc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.rotational_symmetry_number"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.rotational_symmetry_number">[docs]</a>    <span class="k">def</span> <span class="nf">rotational_symmetry_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of unique orientations of the rigid molecule that only interchange identical atoms.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Source http://cccbdb.nist.gov/thermo.asp (search &quot;symmetry number&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_point_group_with_n</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pg</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ATOM&#39;</span><span class="p">,</span> <span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;Ci&#39;</span><span class="p">,</span> <span class="s1">&#39;Cs&#39;</span><span class="p">,</span> <span class="s1">&#39;C_inf_v&#39;</span><span class="p">]:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">pg</span> <span class="o">==</span> <span class="s1">&#39;D_inf_h&#39;</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">pg</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Td&#39;</span><span class="p">]:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">elif</span> <span class="n">pg</span> <span class="o">==</span> <span class="s1">&#39;Oh&#39;</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mi">24</span>
        <span class="k">elif</span> <span class="n">pg</span> <span class="o">==</span> <span class="s1">&#39;Ih&#39;</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="k">elif</span> <span class="n">pg</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cn&#39;</span><span class="p">,</span> <span class="s1">&#39;Cnv&#39;</span><span class="p">,</span> <span class="s1">&#39;Cnh&#39;</span><span class="p">]:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_pg_n</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">pg</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Dn&#39;</span><span class="p">,</span> <span class="s1">&#39;Dnd&#39;</span><span class="p">,</span> <span class="s1">&#39;Dnh&#39;</span><span class="p">]:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_pg_n</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">pg</span> <span class="o">==</span> <span class="s1">&#39;Sn&#39;</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_pg_n</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t ID full symmetry group: &quot;</span> <span class="o">+</span> <span class="n">pg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sigma</span></div>

<div class="viewcode-block" id="Molecule.axis_representation"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.axis_representation">[docs]</a>    <span class="k">def</span> <span class="nf">axis_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zero</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Molecule vs. laboratory frame representation (e.g., IR or IIIL).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        zero</span>
<span class="sd">            Screen for inertial tensor elements</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Representation code IR, IIR, IIIR, IL, IIL, IIIL. When</span>
<span class="sd">            molecule not in inertial frame, string is prefixed by &quot;~&quot;.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Not carefully handling degenerate inertial elements.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inertia_tensor</span><span class="p">(</span><span class="n">zero</span><span class="o">=</span><span class="n">zero</span><span class="p">)</span>
        <span class="n">Iidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">Iidx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])):</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="s1">&#39;IR&#39;</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">Iidx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])):</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="s1">&#39;IIR&#39;</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">Iidx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])):</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="s1">&#39;IIIR&#39;</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">Iidx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])):</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="s1">&#39;IL&#39;</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">Iidx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])):</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="s1">&#39;IIL&#39;</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">Iidx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])):</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="s1">&#39;IIIL&#39;</span>

        <span class="c1"># if inertial tensor has non-zero off-diagonals, this whole classification is iffy</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">it</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">it</span><span class="p">))):</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="n">ar</span>

        <span class="k">return</span> <span class="n">ar</span></div>

<div class="viewcode-block" id="Molecule.to_arrays"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.to_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">to_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ghost_as_dummy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exports coordinate info into NumPy arrays.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dummy</span>
<span class="sd">            Whether or not to include dummy atoms in returned arrays.</span>
<span class="sd">        ghost_as_dummy</span>
<span class="sd">            Whether or not to treat ghost atoms as dummies.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        geom, mass, elem, elez, uniq : ndarray, ndarray, ndarray, ndarray, ndarray</span>
<span class="sd">            (nat, 3) geometry [a0].</span>
<span class="sd">            (nat,) mass [u].</span>
<span class="sd">            (nat,) element symbol.</span>
<span class="sd">            (nat,) atomic number.</span>
<span class="sd">            (nat,) hash of element symbol and mass.</span>
<span class="sd">            Note that coordinate, orientation, and element information is</span>
<span class="sd">            preserved but fragmentation, chgmult, and dummy/ghost is lost.</span>

<span class="sd">        Usage</span>
<span class="sd">        -----</span>
<span class="sd">        geom, mass, elem, elez, uniq = molinstance.to_arrays()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dummy</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
                <span class="c1"># normal qcdb.Molecule</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_geometry</span><span class="p">(</span><span class="n">np_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># psi4.core.Molecule</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_geometry</span><span class="p">())</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([(</span><span class="mf">0.</span> <span class="k">if</span> <span class="p">(</span><span class="n">ghost_as_dummy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fZ</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmass</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
                               <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nallatom</span><span class="p">())])</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;X&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">ghost_as_dummy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fZ</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsymbol</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nallatom</span><span class="p">())])</span>
            <span class="n">elez</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">ghost_as_dummy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fZ</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">fZ</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nallatom</span><span class="p">())])</span>
            <span class="n">uniq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
                <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="n">at</span><span class="p">])</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass</span><span class="p">[</span><span class="n">at</span><span class="p">]))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nallatom</span><span class="p">())</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
                <span class="c1"># normal qcdb.Molecule</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="n">np_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># psi4.core.Molecule</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">())])</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">())])</span>
            <span class="n">elez</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">())])</span>
            <span class="n">uniq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
                <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="n">at</span><span class="p">])</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mass</span><span class="p">[</span><span class="n">at</span><span class="p">]))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">())</span>
            <span class="p">])</span>

        <span class="k">return</span> <span class="n">geom</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">elez</span><span class="p">,</span> <span class="n">uniq</span></div>

<div class="viewcode-block" id="Molecule.from_string"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.from_string">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="n">molstr</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fix_com</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fix_orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fix_symmetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">enable_qm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">enable_efp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">missing_enabled_return_qm</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="n">missing_enabled_return_efp</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span>
            <span class="n">molstr</span><span class="o">=</span><span class="n">molstr</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">fix_com</span><span class="o">=</span><span class="n">fix_com</span><span class="p">,</span>
            <span class="n">fix_orientation</span><span class="o">=</span><span class="n">fix_orientation</span><span class="p">,</span>
            <span class="n">fix_symmetry</span><span class="o">=</span><span class="n">fix_symmetry</span><span class="p">,</span>
            <span class="n">return_processed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">enable_qm</span><span class="o">=</span><span class="n">enable_qm</span><span class="p">,</span>
            <span class="n">enable_efp</span><span class="o">=</span><span class="n">enable_efp</span><span class="p">,</span>
            <span class="n">missing_enabled_return_qm</span><span class="o">=</span><span class="n">missing_enabled_return_qm</span><span class="p">,</span>
            <span class="n">missing_enabled_return_efp</span><span class="o">=</span><span class="n">missing_enabled_return_efp</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;qm&#39;</span><span class="p">]),</span> <span class="n">molrec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;qm&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Molecule.from_arrays"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.from_arrays">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_arrays</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">elea</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">elez</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">elem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">real</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">elbl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Angstrom&#39;</span><span class="p">,</span>
                    <span class="n">input_units_to_au</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fix_com</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">fix_orientation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">fix_symmetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fragment_separators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fragment_charges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fragment_multiplicities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">molecular_charge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">molecular_multiplicity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">provenance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">connectivity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">missing_enabled_return</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                    <span class="n">tooclose</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">zero_ghost_fragments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">nonphysical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">mtol</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct Molecule from unvalidated arrays and variables.</span>

<span class="sd">        Light wrapper around :py:func:`~qcelemental.molparse.from_arrays`</span>
<span class="sd">        that is a full-featured constructor to dictionary representa-</span>
<span class="sd">        tion of Molecule. This follows one step further to return</span>
<span class="sd">        Molecule instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        See :py:func:`~qcelemental.molparse.from_arrays`.</span>
<span class="sd">        return_dict : bool, optional</span>
<span class="sd">            Additionally return Molecule dictionary intermediate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mol : :py:class:`~qcdb.Molecule`</span>
<span class="sd">        molrec : dict, optional</span>
<span class="sd">            Dictionary representation of instance.</span>
<span class="sd">            Only provided if `return_dict` is True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span>
            <span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span>
            <span class="n">elea</span><span class="o">=</span><span class="n">elea</span><span class="p">,</span>
            <span class="n">elez</span><span class="o">=</span><span class="n">elez</span><span class="p">,</span>
            <span class="n">elem</span><span class="o">=</span><span class="n">elem</span><span class="p">,</span>
            <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span>
            <span class="n">real</span><span class="o">=</span><span class="n">real</span><span class="p">,</span>
            <span class="n">elbl</span><span class="o">=</span><span class="n">elbl</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">input_units_to_au</span><span class="o">=</span><span class="n">input_units_to_au</span><span class="p">,</span>
            <span class="n">fix_com</span><span class="o">=</span><span class="n">fix_com</span><span class="p">,</span>
            <span class="n">fix_orientation</span><span class="o">=</span><span class="n">fix_orientation</span><span class="p">,</span>
            <span class="n">fix_symmetry</span><span class="o">=</span><span class="n">fix_symmetry</span><span class="p">,</span>
            <span class="n">fragment_separators</span><span class="o">=</span><span class="n">fragment_separators</span><span class="p">,</span>
            <span class="n">fragment_charges</span><span class="o">=</span><span class="n">fragment_charges</span><span class="p">,</span>
            <span class="n">fragment_multiplicities</span><span class="o">=</span><span class="n">fragment_multiplicities</span><span class="p">,</span>
            <span class="n">molecular_charge</span><span class="o">=</span><span class="n">molecular_charge</span><span class="p">,</span>
            <span class="n">molecular_multiplicity</span><span class="o">=</span><span class="n">molecular_multiplicity</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
            <span class="n">provenance</span><span class="o">=</span><span class="n">provenance</span><span class="p">,</span>
            <span class="n">connectivity</span><span class="o">=</span><span class="n">connectivity</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;qm&#39;</span><span class="p">,</span>
            <span class="n">missing_enabled_return</span><span class="o">=</span><span class="n">missing_enabled_return</span><span class="p">,</span>
            <span class="n">tooclose</span><span class="o">=</span><span class="n">tooclose</span><span class="p">,</span>
            <span class="n">zero_ghost_fragments</span><span class="o">=</span><span class="n">zero_ghost_fragments</span><span class="p">,</span>
            <span class="n">nonphysical</span><span class="o">=</span><span class="n">nonphysical</span><span class="p">,</span>
            <span class="n">mtol</span><span class="o">=</span><span class="n">mtol</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">),</span> <span class="n">molrec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.to_string"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ghost_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Format a string representation of QM molecule.&quot;&quot;&quot;</span>

        <span class="n">molrec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">np_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># flip zeros</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">prec</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">smol</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span>
            <span class="n">molrec</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">atom_format</span><span class="o">=</span><span class="n">atom_format</span><span class="p">,</span>
            <span class="n">ghost_format</span><span class="o">=</span><span class="n">ghost_format</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">prec</span><span class="o">=</span><span class="n">prec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">smol</span></div>

<div class="viewcode-block" id="Molecule.run_dftd3"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.run_dftd3">[docs]</a>    <span class="k">def</span> <span class="nf">run_dftd3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dashlvl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dashparam</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dertype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute dispersion correction via Grimme&#39;s DFTD3 program.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func</span>
<span class="sd">            Name of functional (func only, func &amp; disp, or disp only) for</span>
<span class="sd">            which to compute dispersion (e.g., blyp, BLYP-D2, blyp-d3bj,</span>
<span class="sd">            blyp-d3(bj), hf+d). Any or all parameters initialized</span>
<span class="sd">            from `dashcoeff[dashlvl][func]` can be overwritten via</span>
<span class="sd">            `dashparam`.</span>
<span class="sd">        dashlvl</span>
<span class="sd">            Name of dispersion correction to be applied (e.g., d, D2,</span>
<span class="sd">            d3(bj), das2010). Must be key in `dashcoeff` or &quot;alias&quot; or</span>
<span class="sd">            &quot;formal&quot; to one.</span>
<span class="sd">        dashparam</span>
<span class="sd">            Values for the same keys as `dashcoeff[dashlvl][&#39;default&#39;]`</span>
<span class="sd">            used to override any or all values initialized by `func`.</span>
<span class="sd">            Extra parameters will error.</span>
<span class="sd">        dertype</span>
<span class="sd">            Maximum derivative level at which to run DFTD3. For large</span>
<span class="sd">            molecules, energy-only calculations can be significantly more</span>
<span class="sd">            efficient. Influences return values, see below.</span>
<span class="sd">        verbose</span>
<span class="sd">            Amount of printing.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        energy : float</span>
<span class="sd">            When `dertype=0`, energy [Eh].</span>
<span class="sd">        gradient : ndarray</span>
<span class="sd">            When `dertype=1`, (nat, 3) gradient [Eh/a0].</span>
<span class="sd">        (energy, gradient) : tuple of float and ndarray</span>
<span class="sd">            When `dertype=None`, both energy [Eh] and (nat, 3) gradient [Eh/a0].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">qcengine</span> <span class="k">as</span> <span class="nn">qcng</span>

        <span class="k">if</span> <span class="n">dertype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">derint</span><span class="p">,</span> <span class="n">derdriver</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;gradient&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">derint</span><span class="p">,</span> <span class="n">derdriver</span> <span class="o">=</span> <span class="n">parse_dertype</span><span class="p">(</span><span class="n">dertype</span><span class="p">,</span> <span class="n">max_derivative</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">resinp</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;schema_name&#39;</span><span class="p">:</span> <span class="s1">&#39;qcschema_input&#39;</span><span class="p">,</span>
            <span class="s1">&#39;schema_version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;molecule&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_schema</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="n">derdriver</span><span class="p">,</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
                <span class="s1">&#39;basis&#39;</span><span class="p">:</span> <span class="s1">&#39;(auto)&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;level_hint&#39;</span><span class="p">:</span> <span class="n">dashlvl</span><span class="p">,</span>
                <span class="s1">&#39;params_tweaks&#39;</span><span class="p">:</span> <span class="n">dashparam</span><span class="p">,</span>
                <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">jobrec</span> <span class="o">=</span> <span class="n">qcng</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">resinp</span><span class="p">,</span> <span class="s1">&#39;dftd3&#39;</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">jobrec</span> <span class="o">=</span> <span class="n">jobrec</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

        <span class="c1"># hack as not checking type GRAD</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">qca</span> <span class="ow">in</span> <span class="n">jobrec</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">][</span><span class="s1">&#39;qcvars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qca</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">jobrec</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">][</span><span class="s1">&#39;qcvars&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qca</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">psi4</span> <span class="kn">import</span> <span class="n">core</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">qca</span> <span class="ow">in</span> <span class="n">jobrec</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">][</span><span class="s1">&#39;qcvars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qca</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">qca</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">derint</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">jobrec</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">][</span><span class="s1">&#39;qcvars&#39;</span><span class="p">][</span><span class="s1">&#39;DISPERSION CORRECTION ENERGY&#39;</span><span class="p">]),</span>
                    <span class="n">jobrec</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">][</span><span class="s1">&#39;qcvars&#39;</span><span class="p">][</span><span class="s1">&#39;DISPERSION CORRECTION GRADIENT&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">derint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">jobrec</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">][</span><span class="s1">&#39;qcvars&#39;</span><span class="p">][</span><span class="s1">&#39;DISPERSION CORRECTION ENERGY&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">derint</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jobrec</span><span class="p">[</span><span class="s1">&#39;extras&#39;</span><span class="p">][</span><span class="s1">&#39;qcvars&#39;</span><span class="p">][</span><span class="s1">&#39;DISPERSION CORRECTION GRADIENT&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Molecule.from_schema"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.from_schema">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_schema</span><span class="p">(</span><span class="n">molschema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">return_dict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct Molecule from non-Psi4 schema.</span>

<span class="sd">        Light wrapper around :py:func:`~qcdb.Molecule.from_arrays`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molschema</span>
<span class="sd">            Dictionary form of Molecule following known schema.</span>
<span class="sd">        return_dict</span>
<span class="sd">            Additionally return Molecule dictionary intermediate.</span>
<span class="sd">        verbose</span>
<span class="sd">            Amount of printing.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mol : :py:class:`~qcdb.Molecule`</span>
<span class="sd">        molrec : dict, optional</span>
<span class="sd">            Dictionary representation of instance.</span>
<span class="sd">            Only provided if `return_dict` is True.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_schema</span><span class="p">(</span><span class="n">molschema</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">),</span> <span class="n">molrec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.to_schema"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.to_schema">[docs]</a>    <span class="k">def</span> <span class="nf">to_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Bohr&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Serializes instance into dictionary according to schema `dtype`.&quot;&quot;&quot;</span>

        <span class="n">molrec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">np_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">schmol</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">to_schema</span><span class="p">(</span><span class="n">molrec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">schmol</span></div>

<div class="viewcode-block" id="Molecule.to_dict"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_c1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_units</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">np_out</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Serializes instance into Molecule dictionary.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
        <span class="n">molrec</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">]:</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">]:</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">()</span>

        <span class="c1"># qcdb does not add prov, so rely upon all qcdb.Mol creation happening in molparse for this to return valid value (not [])</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;provenance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;connectivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connectivity</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">force_units</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">:</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bohr&#39;</span>
        <span class="k">elif</span> <span class="n">force_units</span> <span class="o">==</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">:</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Angstrom&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">()</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>
            <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;Angstrom&#39;</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_units_to_au</span><span class="p">()</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-6</span><span class="p">:</span>
                <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;input_units_to_au&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_units_to_au</span><span class="p">()</span>

        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fix_com&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_fixed</span><span class="p">()</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fix_orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation_fixed</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">force_c1</span><span class="p">:</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fix_symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;c1&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_from_input</span><span class="p">():</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fix_symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_from_input</span><span class="p">()</span>

        <span class="c1"># if self.has_zmatrix:</span>
        <span class="c1">#     moldict[&#39;zmat&#39;] = self.zmat</span>
        <span class="c1"># TODO zmat, geometry_variables</span>

        <span class="n">nat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">()</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>  <span class="c1"># [a0]</span>
        <span class="k">if</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Angstrom&#39;</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">*=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span>  <span class="c1">#self.input_units_to_au()</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_number</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)])</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elez&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qcel</span><span class="o">.</span><span class="n">periodictable</span><span class="o">.</span><span class="n">to_Z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">at</span><span class="p">))</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)])</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)])</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)])</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">(</span><span class="n">at</span><span class="p">))</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)])</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elbl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">at</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">at</span><span class="p">)):]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)])</span>

        <span class="n">fragments</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragments</span><span class="p">()]</span>
        <span class="n">fragment_charges</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_charges</span><span class="p">()]</span>
        <span class="n">fragment_multiplicities</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_multiplicities</span><span class="p">()]</span>

        <span class="c1"># do trimming not performed in Molecule class b/c fragment_* member data never directly exposed</span>
        <span class="k">for</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fragment_types</span><span class="p">()))):</span>
            <span class="k">if</span> <span class="n">fr</span> <span class="o">==</span> <span class="s1">&#39;Ghost&#39;</span><span class="p">:</span>
                <span class="n">fragment_charges</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">fragment_multiplicities</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">fr</span> <span class="o">==</span> <span class="s1">&#39;Absent&#39;</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">fragment_charges</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">fragment_multiplicities</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span>
                <span class="c1"># readjust atom indices for subsequent fragments</span>
                <span class="n">renum</span> <span class="o">=</span> <span class="n">fragments</span><span class="p">[</span><span class="n">ifr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">iffr</span><span class="p">,</span> <span class="n">ffr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fragments</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">iffr</span> <span class="o">&lt;=</span> <span class="n">ifr</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">lenfr</span> <span class="o">=</span> <span class="n">ffr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ffr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fragments</span><span class="p">[</span><span class="n">iffr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">renum</span><span class="p">,</span> <span class="n">renum</span> <span class="o">+</span> <span class="n">lenfr</span><span class="p">]</span>
                    <span class="n">renum</span> <span class="o">+=</span> <span class="n">lenfr</span>
                <span class="k">del</span> <span class="n">fragments</span><span class="p">[</span><span class="n">ifr</span><span class="p">]</span>

        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fragment_separators&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>  <span class="c1"># np.int --&gt; int</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fragment_charges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fragment_charges</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fragment_multiplicities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fragment_multiplicities</span>

        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;molecular_charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_charge</span><span class="p">())</span>
        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;molecular_multiplicity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">()</span>

        <span class="c1"># * mass number (elea) untouched by qcdb.Molecule/psi4.core.Molecule and</span>
        <span class="c1">#   likely to be array of -1s, so let from_arrays fill in the values and</span>
        <span class="c1">#   (1) don&#39;t complain about the difference and</span>
        <span class="c1">#   (2) return the from_arrays filled-in values</span>
        <span class="c1"># * from.arrays is expecting speclabel &quot;Co_userlbl&quot; for elbl, but we&#39;re</span>
        <span class="c1">#   sending &quot;_userlbl&quot;, hence speclabel=False</span>
        <span class="c1"># * from.arrays sets difference provenance than input mol</span>
        <span class="n">forgive</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;elea&#39;</span><span class="p">,</span> <span class="s1">&#39;provenance&#39;</span><span class="p">]</span>

        <span class="c1"># * from_arrays and comparison lines below are quite unnecessary to</span>
        <span class="c1">#   to_dict, but is included as a check. in practice, only fills in mass</span>
        <span class="c1">#   numbers and heals user chgmult.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validated_molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">speclabel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;qm&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">molrec</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">qcel</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># * this can legitimately happen if total chg or mult has been set</span>
            <span class="c1">#   independently b/c fragment chg/mult not reset. so try again.</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;Following warning is harmless if you&#39;ve altered chgmult through `set_molecular_change` or `set_multiplicity`. Such alterations are an expert feature. Specifying in the original molecule string is preferred.&quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fragment_charges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span>
            <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fragment_multiplicities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span>
            <span class="n">validated_molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">speclabel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;qm&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">molrec</span><span class="p">)</span>
            <span class="n">forgive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fragment_charges&#39;</span><span class="p">)</span>
            <span class="n">forgive</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fragment_multiplicities&#39;</span><span class="p">)</span>
        <span class="n">compare_molrecs</span><span class="p">(</span><span class="n">validated_molrec</span><span class="p">,</span> <span class="n">molrec</span><span class="p">,</span> <span class="s1">&#39;to_dict&#39;</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="n">forgive</span><span class="o">=</span><span class="n">forgive</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># from_arrays overwrites provenance</span>
        <span class="n">validated_molrec</span><span class="p">[</span><span class="s1">&#39;provenance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;provenance&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np_out</span><span class="p">:</span>
            <span class="n">validated_molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">unnp</span><span class="p">(</span><span class="n">validated_molrec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">validated_molrec</span></div>

<div class="viewcode-block" id="Molecule.from_dict"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">molrec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">mol</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">_internal_from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="o">=</span><span class="n">molrec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mol</span></div>

    <span class="k">def</span> <span class="nf">_internal_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molrec</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs instance from fully validated and defaulted dictionary `molrec`.&quot;&quot;&quot;</span>

        <span class="c1"># Compromises for qcdb.Molecule</span>
        <span class="c1"># * molecular_charge is int, not float</span>
        <span class="c1"># * fragment_charges are int, not float</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lock_frame</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">molrec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;comment&#39;</span> <span class="ow">in</span> <span class="n">molrec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_comment</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_provenance</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;provenance&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="s1">&#39;connectivity&#39;</span> <span class="ow">in</span> <span class="n">molrec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_connectivity</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;connectivity&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_units</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;input_units_to_au&#39;</span> <span class="ow">in</span> <span class="n">molrec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_input_units_to_au</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;input_units_to_au&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;geom_unsettled&#39;</span> <span class="ow">in</span> <span class="n">molrec</span><span class="p">:</span>
            <span class="n">nat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;geom_unsettled&#39;</span><span class="p">])</span>
            <span class="n">unsettled</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;geom_unsettled&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span> <span class="o">+</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elbl&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elez&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_unsettled_atom</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">],</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">],</span> <span class="n">Z</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                        <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elea&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_geometry_variable</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">nat</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">unsettled</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">):</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">geom</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span> <span class="o">+</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elbl&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elez&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">],</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">],</span> <span class="n">Z</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;elea&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">])</span>
                <span class="c1"># TODO charge and 2nd elez site</span>
                <span class="c1"># TODO real back to type Ghost?</span>

        <span class="c1"># apparently py- and c- sides settled on a diff convention of 2nd of pair in fragments_</span>
        <span class="n">fragment_separators</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fragment_separators&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">fragment_separators</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fragment_separators</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">fragment_separators</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment_separators</span><span class="p">,</span> <span class="n">nat</span><span class="p">)</span>
        <span class="n">fragments</span> <span class="o">=</span> <span class="p">[[</span><span class="n">fragment_separators</span><span class="p">[</span><span class="n">ifr</span><span class="p">],</span> <span class="n">fr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fragment_separators</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_fragment_pattern</span><span class="p">(</span><span class="n">fragments</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Real&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">),</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fragment_charges&#39;</span><span class="p">]],</span>
                                  <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fragment_multiplicities&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_molecular_charge</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;molecular_charge&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_multiplicity</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;molecular_multiplicity&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fix_com</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fix_com&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fix_orientation&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;fix_symmetry&#39;</span> <span class="ow">in</span> <span class="n">molrec</span><span class="p">:</span>
            <span class="c1"># Save the user-specified symmetry, but don&#39;t set it as the point group</span>
            <span class="c1"># That step occurs in update_geometry, after the atoms are added</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PYsymmetry_from_input</span> <span class="o">=</span> <span class="n">molrec</span><span class="p">[</span><span class="s1">&#39;fix_symmetry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1">## hack to prevent update_geometry termination upon no atoms</span>
        <span class="c1">#if nat == 0:</span>
        <span class="c1">#    self.set_lock_frame(True)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">unsettled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

<div class="viewcode-block" id="Molecule.BFS"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.BFS">[docs]</a>    <span class="k">def</span> <span class="nf">BFS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">seed_atoms</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">bond_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.20</span><span class="p">,</span>
            <span class="n">return_arrays</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">return_molecules</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">return_molecule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Detect fragments among real atoms through a breadth-first search (BFS) algorithm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        seed_atoms</span>
<span class="sd">            List of lists of atoms (0-indexed) belonging to independent fragments.</span>
<span class="sd">            Useful to prompt algorithm or to define intramolecular fragments through</span>
<span class="sd">            border atoms. Example: `[[1, 0], [2]]`</span>
<span class="sd">        bond_threshold</span>
<span class="sd">            Factor beyond average of covalent radii to determine bond cutoff.</span>
<span class="sd">        return_arrays</span>
<span class="sd">            If `True`, also return fragments as list of arrays.</span>
<span class="sd">        return_molecules</span>
<span class="sd">            If True, also return fragments as list of Molecules.</span>
<span class="sd">        return_molecule</span>
<span class="sd">            If True, also return one big Molecule with fragmentation encoded.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bfs_map : list of lists</span>
<span class="sd">            Array of atom indices (0-indexed) of detected fragments.</span>
<span class="sd">        bfs_arrays : tuple of lists of ndarray, optional</span>
<span class="sd">            geom, mass, elem info per-fragment.</span>
<span class="sd">            Only provided if `return_arrays` is True.</span>
<span class="sd">        bfs_molecules : list of qcdb.Molecule or psi4.core.Molecule, optional</span>
<span class="sd">            List of molecules, each built from one fragment. Center and</span>
<span class="sd">            orientation of fragments is fixed so orientation info from `self` is</span>
<span class="sd">            not lost. Loses chgmult and ghost/dummy info from `self` and contains</span>
<span class="sd">            default chgmult.</span>
<span class="sd">            Only provided if `return_molecules` is True.</span>
<span class="sd">            Returned are of same type as `self`.</span>
<span class="sd">        bfs_molecule : qcdb.Molecule or psi4.core.Molecule, optional</span>
<span class="sd">            Single molecule with same number of real atoms as `self` with atoms</span>
<span class="sd">            reordered into adjacent fragments and fragment markers inserted.</span>
<span class="sd">            Loses ghost/dummy info from `self`; keeps total charge but not total mult.</span>
<span class="sd">            Only provided if `return_molecule` is True.</span>
<span class="sd">            Returned is of same type as `self`.</span>

<span class="sd">        Authors</span>
<span class="sd">        -------</span>
<span class="sd">        Original code from Michael S. Marshall, linear-scaling algorithm from</span>
<span class="sd">        Trent M. Parker, revamped by Lori A. Burns</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        * Relies upon van der Waals radii and so faulty for close (especially hydrogen-bonded) fragments. See `seed_atoms`.</span>
<span class="sd">        * Any existing fragmentation info/chgmult encoded in `self` is lost.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nallatom</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;BFS not adapted for dummy atoms&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">cgeom</span><span class="p">,</span> <span class="n">cmass</span><span class="p">,</span> <span class="n">celem</span><span class="p">,</span> <span class="n">celez</span><span class="p">,</span> <span class="n">cuniq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_arrays</span><span class="p">()</span>
        <span class="n">frag_pattern</span> <span class="o">=</span> <span class="n">BFS</span><span class="p">(</span><span class="n">cgeom</span><span class="p">,</span> <span class="n">celez</span><span class="p">,</span> <span class="n">seed_atoms</span><span class="o">=</span><span class="n">seed_atoms</span><span class="p">,</span> <span class="n">bond_threshold</span><span class="o">=</span><span class="n">bond_threshold</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">frag_pattern</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">return_arrays</span><span class="p">:</span>
            <span class="n">fgeoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">cgeom</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">frag_pattern</span><span class="p">]</span>
            <span class="n">fmasss</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmass</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">frag_pattern</span><span class="p">]</span>
            <span class="n">felems</span> <span class="o">=</span> <span class="p">[</span><span class="n">celem</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">frag_pattern</span><span class="p">]</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fgeoms</span><span class="p">,</span> <span class="n">fmasss</span><span class="p">,</span> <span class="n">felems</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_molecules</span><span class="p">:</span>
            <span class="n">molrecs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span>
                    <span class="n">geom</span><span class="o">=</span><span class="n">cgeom</span><span class="p">[</span><span class="n">fr</span><span class="p">],</span>
                    <span class="n">mass</span><span class="o">=</span><span class="n">cmass</span><span class="p">[</span><span class="n">fr</span><span class="p">],</span>
                    <span class="n">elem</span><span class="o">=</span><span class="n">celem</span><span class="p">[</span><span class="n">fr</span><span class="p">],</span>
                    <span class="n">elez</span><span class="o">=</span><span class="n">celez</span><span class="p">[</span><span class="n">fr</span><span class="p">],</span>
                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Bohr&#39;</span><span class="p">,</span>
                    <span class="n">fix_com</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">fix_orientation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">frag_pattern</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
                <span class="n">ret_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">)</span> <span class="k">for</span> <span class="n">molrec</span> <span class="ow">in</span> <span class="n">molrecs</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">psi4</span> <span class="kn">import</span> <span class="n">core</span>
                <span class="n">ret_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">core</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">)</span> <span class="k">for</span> <span class="n">molrec</span> <span class="ow">in</span> <span class="n">molrecs</span><span class="p">]</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret_mols</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_molecule</span><span class="p">:</span>
            <span class="n">dcontig</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">contiguize_from_fragment_pattern</span><span class="p">(</span>
                <span class="n">frag_pattern</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="n">cgeom</span><span class="p">,</span> <span class="n">elez</span><span class="o">=</span><span class="n">celez</span><span class="p">,</span> <span class="n">elem</span><span class="o">=</span><span class="n">celem</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">cmass</span><span class="p">)</span>
            <span class="n">molrec</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molparse</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span>
                <span class="n">geom</span><span class="o">=</span><span class="n">dcontig</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">],</span>
                <span class="n">mass</span><span class="o">=</span><span class="n">dcontig</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],</span>
                <span class="n">elem</span><span class="o">=</span><span class="n">dcontig</span><span class="p">[</span><span class="s1">&#39;elem&#39;</span><span class="p">],</span>
                <span class="n">elez</span><span class="o">=</span><span class="n">dcontig</span><span class="p">[</span><span class="s1">&#39;elez&#39;</span><span class="p">],</span>
                <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Bohr&#39;</span><span class="p">,</span>
                <span class="n">molecular_charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_charge</span><span class="p">(),</span>
                <span class="c1"># molecular_multiplicity may not be conservable upon fragmentation</span>
                <span class="c1">#   potentially could do two passes and try to preserve it</span>
                <span class="n">fix_com</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">com_fixed</span><span class="p">(),</span>
                <span class="n">fix_orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation_fixed</span><span class="p">(),</span>
                <span class="n">fix_symmetry</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_from_input</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_from_input</span><span class="p">()),</span>
                <span class="n">fragment_separators</span><span class="o">=</span><span class="n">dcontig</span><span class="p">[</span><span class="s1">&#39;fragment_separators&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
                <span class="n">ret_mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">psi4</span> <span class="kn">import</span> <span class="n">core</span>
                <span class="n">ret_mol</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">molrec</span><span class="p">)</span>

            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret_mol</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">frag_pattern</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></div>

<div class="viewcode-block" id="Molecule.B787"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.B787">[docs]</a>    <span class="k">def</span> <span class="nf">B787</span><span class="p">(</span><span class="n">concern_mol</span><span class="p">:</span> <span class="s2">&quot;Molecule&quot;</span><span class="p">,</span>
             <span class="n">ref_mol</span><span class="p">:</span> <span class="s2">&quot;Molecule&quot;</span><span class="p">,</span>
             <span class="o">*</span><span class="p">,</span>
             <span class="n">fix_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">do_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
             <span class="n">atoms_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">run_resorting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">mols_align</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">run_to_completion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">uno_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.e-3</span><span class="p">,</span>
             <span class="n">run_mirror</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds shift, rotation, and atom reordering of `concern_mol` that best</span>
<span class="sd">        aligns with `ref_mol`.</span>

<span class="sd">        Wraps :py:func:`qcelemental.molutil.align.B787` for :py:class:`qcdb.Molecule` or</span>
<span class="sd">        :py:class:`psi4.core.Molecule`. Employs the Kabsch, Hungarian, and</span>
<span class="sd">        Uno algorithms to exhaustively locate the best alignment for</span>
<span class="sd">        non-oriented, non-ordered structures.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        concern_mol</span>
<span class="sd">            Molecule of concern, to be shifted, rotated, and reordered into</span>
<span class="sd">            best coincidence with `ref_mol`.</span>
<span class="sd">        ref_mol</span>
<span class="sd">            Molecule to match.</span>
<span class="sd">        fix_mode</span>
<span class="sd">            {&quot;copy&quot;, &quot;true&quot;}</span>
<span class="sd">            Relevant to the ``fix_com``, ``fix_orientation``, and ``geometry`` state of the returned Molecule.</span>
<span class="sd">            ``fixed_mode=&quot;copy&quot;`` uses the ``fix_com`` and ``fix_orientation`` (hereafter fix_) attributes of</span>
<span class="sd">            ``concern_mol`` (self) to create the returned molecule. The perhaps unexpected implication if fix_=F is that</span>
<span class="sd">            the resultant molecule will be in standard orientation (pretty) and *NOT ALIGNED TO REF_MOL*. Nevertheless,</span>
<span class="sd">            this is sometimes useful when imitating the original construction of a molecule. ``fixed_mode=&quot;true&quot; sets</span>
<span class="sd">            ``fix_com=True`` and ``fix_orientation=True`` to create the returned molecule. The perhaps unexpected</span>
<span class="sd">            implication if fix_=F is that the resultant molecule will *DIFFER FROM CONCERN_MOL BY MORE THAN GEOMETRY*.</span>
<span class="sd">            Nevertheless, this is the common usage so that the returned molecule actually has the aligned geometry</span>
<span class="sd">            regardless of ``concern_mol`` (self) fix_. Note that a possible compromise of returned molecule always</span>
<span class="sd">            having the aligned geometry and the input fix_ is technically possible but contrary to the Molecule design.</span>
<span class="sd">        atoms_map</span>
<span class="sd">            Whether atom1 of `ref_mol` corresponds to atom1 of `concern_mol`, etc.</span>
<span class="sd">            If true, specifying `True` can save much time.</span>
<span class="sd">        mols_align</span>
<span class="sd">            Whether `ref_mol` and `concern_mol` have identical geometries by eye</span>
<span class="sd">            (barring orientation or atom mapping) and expected final RMSD = 0.</span>
<span class="sd">            If `True`, procedure is truncated when RMSD condition met, saving time.</span>
<span class="sd">        do_plot</span>
<span class="sd">            Pops up a mpl plot showing before, after, and ref geometries.</span>
<span class="sd">        run_to_completion</span>
<span class="sd">            Run reorderings to completion (past RMSD = 0) even if unnecessary because</span>
<span class="sd">            `mols_align=True`. Used to test worst-case timings.</span>
<span class="sd">        run_resorting</span>
<span class="sd">            Run the resorting machinery even if unnecessary because `atoms_map=True`.</span>
<span class="sd">        uno_cutoff</span>
<span class="sd">            TODO</span>
<span class="sd">        run_mirror</span>
<span class="sd">            Run alternate geometries potentially allowing best match to `ref_mol`</span>
<span class="sd">            from mirror image of `concern_mol`. Only run if system confirmed to</span>
<span class="sd">            be nonsuperimposable upon mirror reflection.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float, tuple, qcdb.Molecule or psi4.core.Molecule</span>
<span class="sd">            First item is RMSD [A] between `ref_mol` and the optimally aligned</span>
<span class="sd">            geometry computed.</span>
<span class="sd">            Second item is a AlignmentMill namedtuple with fields</span>
<span class="sd">            (shift, rotation, atommap, mirror) that prescribe the transformation</span>
<span class="sd">            from `concern_mol` and the optimally aligned geometry.</span>
<span class="sd">            Third item is a crude charge-, multiplicity-, fragment-less Molecule</span>
<span class="sd">            at optimally aligned (and atom-ordered) geometry. Return type</span>
<span class="sd">            determined by `concern_mol` type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rgeom</span><span class="p">,</span> <span class="n">rmass</span><span class="p">,</span> <span class="n">relem</span><span class="p">,</span> <span class="n">relez</span><span class="p">,</span> <span class="n">runiq</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">to_arrays</span><span class="p">()</span>
        <span class="n">cgeom</span><span class="p">,</span> <span class="n">cmass</span><span class="p">,</span> <span class="n">celem</span><span class="p">,</span> <span class="n">celez</span><span class="p">,</span> <span class="n">cuniq</span> <span class="o">=</span> <span class="n">concern_mol</span><span class="o">.</span><span class="n">to_arrays</span><span class="p">()</span>

        <span class="n">rmsd</span><span class="p">,</span> <span class="n">solution</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molutil</span><span class="o">.</span><span class="n">B787</span><span class="p">(</span>
            <span class="n">cgeom</span><span class="o">=</span><span class="n">cgeom</span><span class="p">,</span>
            <span class="n">rgeom</span><span class="o">=</span><span class="n">rgeom</span><span class="p">,</span>
            <span class="n">cuniq</span><span class="o">=</span><span class="n">cuniq</span><span class="p">,</span>
            <span class="n">runiq</span><span class="o">=</span><span class="n">runiq</span><span class="p">,</span>
            <span class="n">do_plot</span><span class="o">=</span><span class="n">do_plot</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">atoms_map</span><span class="o">=</span><span class="n">atoms_map</span><span class="p">,</span>
            <span class="n">run_resorting</span><span class="o">=</span><span class="n">run_resorting</span><span class="p">,</span>
            <span class="n">mols_align</span><span class="o">=</span><span class="n">mols_align</span><span class="p">,</span>
            <span class="n">run_to_completion</span><span class="o">=</span><span class="n">run_to_completion</span><span class="p">,</span>
            <span class="n">run_mirror</span><span class="o">=</span><span class="n">run_mirror</span><span class="p">,</span>
            <span class="n">uno_cutoff</span><span class="o">=</span><span class="n">uno_cutoff</span><span class="p">)</span>

        <span class="n">ageom</span> <span class="o">=</span> <span class="n">solution</span><span class="o">.</span><span class="n">align_coordinates</span><span class="p">(</span><span class="n">cgeom</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fix_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
            <span class="n">fix_com</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fix_orientation</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">fix_mode</span> <span class="o">==</span> <span class="s2">&quot;copy&quot;</span><span class="p">:</span>
            <span class="n">fix_com</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">com_fixed</span><span class="p">()</span>
            <span class="n">fix_orientation</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">orientation_fixed</span><span class="p">()</span>

        <span class="n">cdict</span> <span class="o">=</span> <span class="n">concern_mol</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">aupdate</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;elem&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">celem</span><span class="p">),</span>
            <span class="s2">&quot;geom&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">align_coordinates</span><span class="p">(</span><span class="n">cgeom</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">cmass</span><span class="p">),</span>
            <span class="s2">&quot;real&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;real&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;elbl&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;elbl&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;elez&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">celez</span><span class="p">),</span>
            <span class="s2">&quot;elea&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;elea&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;fix_com&quot;</span><span class="p">:</span> <span class="n">fix_com</span><span class="p">,</span>
            <span class="s2">&quot;fix_orientation&quot;</span><span class="p">:</span> <span class="n">fix_orientation</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">adict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">cdict</span><span class="p">,</span> <span class="o">**</span><span class="n">aupdate</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;Bohr&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">concern_mol</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
            <span class="n">amol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">adict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">psi4</span> <span class="kn">import</span> <span class="n">core</span>
            <span class="n">amol</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">adict</span><span class="p">)</span>

        <span class="n">compare_values</span><span class="p">(</span>
            <span class="n">concern_mol</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">(),</span>
            <span class="n">amol</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">(),</span>
            <span class="s1">&#39;Q: concern_mol--&gt;returned_mol NRE uncorrupted&#39;</span><span class="p">,</span>
            <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-4</span><span class="p">,</span>
            <span class="n">quiet</span><span class="o">=</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mols_align</span><span class="p">:</span>
            <span class="n">compare_values</span><span class="p">(</span>
                <span class="n">ref_mol</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">(),</span>
                <span class="n">amol</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">(),</span>
                <span class="s1">&#39;Q: concern_mol--&gt;returned_mol NRE matches ref_mol&#39;</span><span class="p">,</span>
                <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-4</span><span class="p">,</span>
                <span class="n">quiet</span><span class="o">=</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">compare</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ref_mol</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span> <span class="n">amol</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-4</span><span class="p">),</span>
                <span class="s1">&#39;Q: concern_mol--&gt;returned_mol geometry matches ref_mol&#39;</span><span class="p">,</span>
                <span class="n">quiet</span><span class="o">=</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">rmsd</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">amol</span></div>

        <span class="c1"># Notes</span>
        <span class="c1">#</span>
        <span class="c1"># * doing the illegal (pre fix_mode) amol with aligned geom and concern_mol fix_</span>
        <span class="c1">#   aupdate = {</span>
        <span class="c1">#       ...</span>
        <span class="c1">#       # signal to build returned Mol with exactly the aligned Cartesians of &quot;geom&quot; rather than psi std frame</span>
        <span class="c1">#       &quot;fix_com&quot;: True,</span>
        <span class="c1">#       &quot;fix_orientation&quot;: True,</span>
        <span class="c1">#   }</span>
        <span class="c1">#   ... amol = Molecule.from_dict(adict)</span>
        <span class="c1">#   # correct fix_* properties of returned Mol to match self</span>
        <span class="c1">#   amol.fix_com(concern_mol.com_fixed())</span>
        <span class="c1">#   amol.fix_orientation(concern_mol.orientation_fixed())</span>

<div class="viewcode-block" id="Molecule.scramble"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.scramble">[docs]</a>    <span class="k">def</span> <span class="nf">scramble</span><span class="p">(</span><span class="n">ref_mol</span><span class="p">:</span> <span class="s2">&quot;Molecule&quot;</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">do_shift</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">do_rotate</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">do_resort</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">deflection</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">do_mirror</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">do_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">do_test</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">run_to_completion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">run_resorting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">fix_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generate a Molecule with random or directed translation, rotation, and atom shuffling.</span>
<span class="sd">        Optionally, check that the aligner returns the opposite transformation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ref_mol</span>
<span class="sd">            Molecule to perturb.</span>
<span class="sd">        do_shift</span>
<span class="sd">            Whether to generate a random atom shift on interval [-3, 3) in each</span>
<span class="sd">            dimension (`True`) or leave at current origin. To shift by a specified</span>
<span class="sd">            vector, supply a 3-element list.</span>
<span class="sd">        do_rotate</span>
<span class="sd">            Whether to generate a random 3D rotation according to algorithm of Arvo.</span>
<span class="sd">            To rotate by a specified matrix, supply a 9-element list of lists.</span>
<span class="sd">        do_resort</span>
<span class="sd">            Whether to shuffle atoms (`True`) or leave 1st atom 1st, etc. (`False`).</span>
<span class="sd">            To specify shuffle, supply a nat-element list of indices.</span>
<span class="sd">        deflection</span>
<span class="sd">            If `do_rotate`, how random a rotation: 0.0 is no change, 0.1 is small</span>
<span class="sd">            perturbation, 1.0 is completely random.</span>
<span class="sd">        do_mirror</span>
<span class="sd">            Whether to construct the mirror image structure by inverting y-axis.</span>
<span class="sd">        do_plot</span>
<span class="sd">            Pops up a mpl plot showing before, after, and ref geometries.</span>
<span class="sd">        do_test</span>
<span class="sd">            Additionally, run the aligner on the returned Molecule and check that</span>
<span class="sd">            opposite transformations obtained.</span>
<span class="sd">        run_to_completion</span>
<span class="sd">            By construction, scrambled systems are fully alignable (final RMSD=0).</span>
<span class="sd">            Even so, `True` turns off the mechanism to stop when RMSD reaches zero</span>
<span class="sd">            and instead proceed to worst possible time.</span>
<span class="sd">        run_resorting</span>
<span class="sd">            Even if atoms not shuffled, test the resorting machinery.</span>
<span class="sd">        fix_mode</span>
<span class="sd">            {&quot;copy&quot;, &quot;true&quot;}</span>
<span class="sd">            Relevant to the ``fix_com``, ``fix_orientation``, and ``geometry`` state of the returned Molecule.</span>
<span class="sd">            ``fixed_mode=&quot;copy&quot;`` uses the ``fix_com`` and ``fix_orientation`` (hereafter fix_) attributes of</span>
<span class="sd">            ``concern_mol`` (self) to create the returned molecule. The perhaps unexpected implication if fix_=F is that</span>
<span class="sd">            the resultant molecule will be in standard orientation (pretty) and *NOT ALIGNED TO REF_MOL*. Nevertheless,</span>
<span class="sd">            this is sometimes useful when imitating the original construction of a molecule. ``fixed_mode=&quot;true&quot; sets</span>
<span class="sd">            ``fix_com=True`` and ``fix_orientation=True`` to create the returned molecule. The perhaps unexpected</span>
<span class="sd">            implication if fix_=F is that the resultant molecule will *DIFFER FROM CONCERN_MOL BY MORE THAN GEOMETRY*.</span>
<span class="sd">            Nevertheless, this is the common usage so that the returned molecule actually has the aligned geometry</span>
<span class="sd">            regardless of ``concern_mol`` (self) fix_. Note that a possible compromise of returned molecule always</span>
<span class="sd">            having the aligned geometry and the input fix_ is technically possible but contrary to the Molecule design.</span>
<span class="sd">        verbose</span>
<span class="sd">            Print level.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mol : Molecule</span>
<span class="sd">        data : Dict[key, Any]</span>
<span class="sd">            Molecule is scrambled copy of `ref_mol` (self).</span>
<span class="sd">            `data[&#39;rmsd&#39;]` is RMSD [A] between `ref_mol` and the scrambled geometry.</span>
<span class="sd">            `data[&#39;mill&#39;]` is a AlignmentMill with fields</span>
<span class="sd">            (shift, rotation, atommap, mirror) that prescribe the transformation</span>
<span class="sd">            from `ref_mol` to the returned geometry.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rgeom</span><span class="p">,</span> <span class="n">rmass</span><span class="p">,</span> <span class="n">relem</span><span class="p">,</span> <span class="n">relez</span><span class="p">,</span> <span class="n">runiq</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">to_arrays</span><span class="p">()</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="n">rgeom</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">perturbation</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">molutil</span><span class="o">.</span><span class="n">compute_scramble</span><span class="p">(</span>
            <span class="n">nat</span><span class="p">,</span>
            <span class="n">do_shift</span><span class="o">=</span><span class="n">do_shift</span><span class="p">,</span>
            <span class="n">do_rotate</span><span class="o">=</span><span class="n">do_rotate</span><span class="p">,</span>
            <span class="n">deflection</span><span class="o">=</span><span class="n">deflection</span><span class="p">,</span>
            <span class="n">do_resort</span><span class="o">=</span><span class="n">do_resort</span><span class="p">,</span>
            <span class="n">do_mirror</span><span class="o">=</span><span class="n">do_mirror</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fix_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
            <span class="n">fix_com</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fix_orientation</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">fix_mode</span> <span class="o">==</span> <span class="s2">&quot;copy&quot;</span><span class="p">:</span>
            <span class="n">fix_com</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">com_fixed</span><span class="p">()</span>
            <span class="n">fix_orientation</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">orientation_fixed</span><span class="p">()</span>

        <span class="n">rdict</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">cgeom</span> <span class="o">=</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">align_coordinates</span><span class="p">(</span><span class="n">rgeom</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cupdate</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;elem&quot;</span><span class="p">:</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">relem</span><span class="p">),</span>
            <span class="s2">&quot;geom&quot;</span><span class="p">:</span> <span class="n">cgeom</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">rmass</span><span class="p">),</span>
            <span class="s2">&quot;real&quot;</span><span class="p">:</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;real&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;elbl&quot;</span><span class="p">:</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;elbl&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;elez&quot;</span><span class="p">:</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">relez</span><span class="p">),</span>
            <span class="s2">&quot;elea&quot;</span><span class="p">:</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">align_atoms</span><span class="p">(</span><span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;elea&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;fix_com&quot;</span><span class="p">:</span> <span class="n">fix_com</span><span class="p">,</span>
            <span class="s2">&quot;fix_orientation&quot;</span><span class="p">:</span> <span class="n">fix_orientation</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">rdict</span><span class="p">,</span> <span class="o">**</span><span class="n">cupdate</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;Bohr&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_mol</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
            <span class="n">cmol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">psi4</span> <span class="kn">import</span> <span class="n">core</span>
            <span class="n">cmol</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>


        <span class="n">rmsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cgeom</span> <span class="o">-</span> <span class="n">rgeom</span><span class="p">)</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start RMSD = </span><span class="si">{:8.4f}</span><span class="s1"> [A]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rmsd</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
            <span class="n">final_rmsd</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">amol</span> <span class="o">=</span> <span class="n">cmol</span><span class="o">.</span><span class="n">B787</span><span class="p">(</span>
                <span class="n">ref_mol</span><span class="p">,</span>
                <span class="n">do_plot</span><span class="o">=</span><span class="n">do_plot</span><span class="p">,</span>
                <span class="n">atoms_map</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">do_resort</span><span class="p">),</span>
                <span class="n">run_resorting</span><span class="o">=</span><span class="n">run_resorting</span><span class="p">,</span>
                <span class="n">mols_align</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">run_to_completion</span><span class="o">=</span><span class="n">run_to_completion</span><span class="p">,</span>
                <span class="n">run_mirror</span><span class="o">=</span><span class="n">do_mirror</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="n">compare</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">solution</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">),</span> <span class="s1">&#39;shifts equiv&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">do_resort</span><span class="p">:</span>
                <span class="n">compare</span><span class="p">(</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">solution</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">perturbation</span><span class="o">.</span><span class="n">rotation</span><span class="p">),</span>
                    <span class="s1">&#39;rotations transpose&#39;</span><span class="p">,</span>
                    <span class="n">quiet</span><span class="o">=</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">solution</span><span class="o">.</span><span class="n">mirror</span><span class="p">:</span>
                <span class="n">compare</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_mirror</span><span class="p">,</span> <span class="s1">&#39;mirror allowed&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cmol</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rmsd&quot;</span><span class="p">:</span> <span class="n">rmsd</span><span class="p">,</span> <span class="s2">&quot;mill&quot;</span><span class="p">:</span> <span class="n">perturbation</span><span class="p">}</span></div>

        <span class="c1"># Notes</span>
        <span class="c1">#</span>
        <span class="c1"># * doing the illegal (pre fix_mode) amol with aligned geom and concern_mol fix_</span>
        <span class="c1">#   cupdate = {</span>
        <span class="c1">#       ...</span>
        <span class="c1">#       # signal to build returned Mol with exactly the aligned Cartesians of &quot;geom&quot; rather than psi std frame</span>
        <span class="c1">#       &quot;fix_com&quot;: True,</span>
        <span class="c1">#       &quot;fix_orientation&quot;: True,</span>
        <span class="c1">#   }</span>
        <span class="c1">#   cdict = {**rdict, **cupdate, &quot;units&quot;: &quot;Bohr&quot;}</span>
        <span class="c1">#   ... cmol = Molecule.from_dict(cdict)</span>
        <span class="c1">#   # correct fix_* properties of returned Mol to match self</span>
        <span class="c1">#   cmol.fix_com(ref_mol.com_fixed())</span>
        <span class="c1">#   cmol.fix_orientation(ref_mol.orientation_fixed())</span>

<div class="viewcode-block" id="Molecule.set_fragment_pattern"><a class="viewcode-back" href="../../../api/qcdb.Molecule.html#qcdb.Molecule.set_fragment_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">set_fragment_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frl</span><span class="p">,</span> <span class="n">frt</span><span class="p">,</span> <span class="n">frc</span><span class="p">,</span> <span class="n">frm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set fragment member data through public method analogous to psi4.core.Molecule&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frl</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">frt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">frc</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">frm</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Molecule::set_fragment_pattern: fragment arguments not of same length.&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">frl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragment_types</span> <span class="o">=</span> <span class="n">frt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragment_charges</span> <span class="o">=</span> <span class="n">frc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragment_multiplicities</span> <span class="o">=</span> <span class="n">frm</span></div></div>


<span class="c1"># Attach methods to qcdb.Molecule class</span>
<span class="kn">from</span> <span class="nn">.parker</span> <span class="kn">import</span> <span class="n">xyz2mol</span> <span class="k">as</span> <span class="n">_parker_xyz2mol_yo</span>  <span class="c1"># isort:skip</span>
<span class="n">Molecule</span><span class="o">.</span><span class="n">format_molecule_for_mol</span> <span class="o">=</span> <span class="n">_parker_xyz2mol_yo</span>
<span class="c1">#from .interface_gcp import run_gcp as _gcp_qcdb_yo</span>
<span class="c1">#Molecule.run_gcp = _gcp_qcdb_yo</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../../../index.html" title="index">
          <img class="logo" src="../../../_static/qcdbsquare.png" alt="Logo"/>
        </a></p><!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->


<div id="searchbox" style="display: none" role="search">
  <!--<h3>Quick search</h3>-->
    <form class="search" action="../../../search.html" method="get">
      <!--<div><input type="text" name="q" placeholder="search docs" /></div>-->
      <div><input type="text" name="q" placeholder="&#xF002;" style="font-family:FontAwesome, Ariel" /></div>
      <!--<div><input type="submit" value="Go" /></div>-->
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >Index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../../../index.html" title="Table Of Contents"
             ><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="https://github.com/qcdb/qcdb/blob/master/README.md"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="https://github.com/qcdb/qcdb"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="https://github.com/qcdb/qcdb/edit/master/docs/sphinx/_modules/qcdb/molecule/molecule.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="https://github.com/qcdb/qcdb/tree/0+untagged.1.ga43ff39">0+untagged.1.ga43ff39</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="../../../index.html">
        <span style="font-family: Optima, sans-serif;">QCDB</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>
        <li class="nav-item nav-item-this"><a href="">qcdb.molecule.molecule</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2021, The QCDB Project.
      Last updated on Wednesday, 08 December 2021 05:23AM.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>